// three.js / threejs.org/license
'use strict';var RVO={REVISION:"2.0",EPSILON:1E-4,MAX_LEAF_SIZE:10};RVO.ToDeg=180/Math.PI;RVO.Simulator=function(){this.agents_=[];this.obstacles_=[];this.defaultAgent_=null;this.kdTree_=new RVO.KdTree;this.kdTree_.parent=this;this.timeStep_=1;this.performance=new RVO.Performance};
RVO.Simulator.prototype={constructor:RVO.Simulator,clear:function(){for(var a=this.agents_.length;a--;)this.agents_.pop();for(a=this.obstacles_.length;a--;)this.obstacles_.pop()},doStep:function(){var a=Date.now();this.kdTree_.buildAgentTree();var b=Date.now();this.performance.KdTree=b-a;for(a=this.agents_.length;a--;)this.agents_[a].computeNeighbors(),this.agents_[a].computeNewVelocity(),this.agents_[a].update();a=Date.now();this.performance.updateAgent=a-b;a-1E3>this.performance.time_prev&&(this.performance.time_prev=
a,this.performance.fpsint=this.performance.fps,this.performance.fps=0);this.performance.fps++},processObstacles:function(){this.kdTree_.buildObstacleTree()},queryVisibility:function(a,b,d){return this.kdTree_.queryVisibility(a,b,d)},addObstacle:function(a){if(2>a.length)return-1;for(var b=this.obstacles_.length,d=0,c=a.length;d!==c;++d){var f=new RVO.Obstacle;f.point_=a[d];0!=d&&(f.prevObstacle_=this.obstacles_[this.obstacles_.length-1],f.prevObstacle_.nextObstacle_=f);d==a.length-1&&(f.nextObstacle_=
this.obstacles_[b],f.nextObstacle_.prevObstacle_=f);f.unitDir_=a[d==a.length-1?0:d+1].moins(a[d]).normalize();f.isConvex_=2==a.length?!0:0<=RVO.LeftOf(a[0==d?a.length-1:d-1],a[d],a[d==a.length-1?0:d+1]);f.id_=this.obstacles_.length;this.obstacles_.push(f)}return b},addAgent:function(a){if(null===this.defaultAgent_)return-1;var b=new RVO.Agent;b.parent=this;b.position_=a;b.maxNeighbors_=this.defaultAgent_.maxNeighbors_;b.maxSpeed_=this.defaultAgent_.maxSpeed_;b.neighborDist_=this.defaultAgent_.neighborDist_;
b.radius_=this.defaultAgent_.radius_;b.timeHorizon_=this.defaultAgent_.timeHorizon_;b.timeHorizonObst_=this.defaultAgent_.timeHorizonObst_;b.velocity_=this.defaultAgent_.velocity_;b.id_=this.agents_.length;this.agents_[b.id_]=b},setAgentDefaults:function(a,b,d,c,f,g,e){"undefined"===typeof e&&(e=new RVO.Vector2(0,0));null==this.defaultAgent_&&(this.defaultAgent_=new RVO.Agent);this.defaultAgent_.maxNeighbors_=b;this.defaultAgent_.maxSpeed_=g;this.defaultAgent_.neighborDist_=a;this.defaultAgent_.radius_=
f;this.defaultAgent_.timeHorizon_=d;this.defaultAgent_.timeHorizonObst_=c;this.defaultAgent_.velocity_=e},setAgentPrefVelocity:function(a,b){this.agents_[a].prefVelocity_=b},setTimeStep:function(a){this.timeStep_=a},setAgentMaxSpeed:function(a,b){this.agents_[a].maxSpeed_=b},setAgentRadius:function(a,b){this.agents_[a].radius_=b},getAgentOrientation:function(a){return this.agents_[a].orientation_},getOrca:function(a){return this.agents_[a].orcaLines_},getAgentPositionScreen:function(a){return this.agents_[a].positionScreen_},
getAgentVelocity:function(a){return this.agents_[a].velocity_},getAgentOldVelocity:function(a){return this.agents_[a].prefVelocity_},getAgentPosition:function(a){return this.agents_[a].position_},getNumAgents:function(){return this.agents_.length},getAgentRadius:function(a){return this.agents_[a].radius_}};RVO.Agent=function(){this.parent=null;this.agentNeighbors_=[];this.obstacleNeighbors_=[];this.orcaLines_=[];this.orientation_=this.neighborDist_=this.maxSpeed_=this.maxNeighbors_=0;this.positionScreen_=new RVO.Vector2(0,0);this.prefVelocity_=new RVO.Vector2(0,0);this.id_=this.timeHorizonObst_=this.timeHorizon_=this.radius_=0;this.test=[];this.c=0;this.RangeSq=null;this.position_=new RVO.Vector2(0,0);this.oldPosition_=new RVO.Vector2(0,0)};
RVO.Agent.prototype={constructor:RVO.Agent,computeNeighbors:function(){this.obstacleNeighbors_=[];var a=RVO.Sqr(this.timeHorizonObst_*this.maxSpeed_+this.radius_);this.parent.kdTree_.computeObstacleNeighbors(this,a);this.agentNeighbors_=[];0<this.maxNeighbors_&&(this.RangeSq=RVO.Sqr(this.neighborDist_),this.parent.kdTree_.computeAgentNeighbors(this,this.RangeSq))},computeNewVelocity:function(){this.orcaLines_=[];for(var a=1/this.timeHorizonObst_,b=0,d=this.obstacleNeighbors_.length;b!==d;++b){for(var c=
this.obstacleNeighbors_[b].Value,f=c.nextObstacle_,g=c.point_.moins(this.position_),e=f.point_.moins(this.position_),h=!1,k=0,n=this.orcaLines_.length;k!==n;++k)if(RVO.Det(g.mul_k(a).moins(this.orcaLines_[k].point),this.orcaLines_[k].direction)-a*this.radius_>=-RVO.EPSILON&&RVO.Det(e.mul_k(a).moins(this.orcaLines_[k].point),this.orcaLines_[k].direction)-a*this.radius_>=-RVO.EPSILON){h=!0;break}if(!h){var m=g.absSq(),n=e.absSq(),l=RVO.Sqr(this.radius_),h=f.point_.moins(c.point_),k=g.moinsSelf().mul(h)/
h.absSq(),p=g.moinsSelf().plus(h.mul_k(-k)).absSq(),h=new RVO.Line;if(0>k&&m<=l)c.isConvex_&&(h.point=new RVO.Vector2(0,0),h.direction=(new RVO.Vector2(-g.y,g.x)).normalize(),this.orcaLines_.push(h));else if(1<k&&n<=l)f.isConvex_&&0<=RVO.Det(e,f.unitDir_)&&(h.point=new RVO.Vector2(0,0),h.direction=(new RVO.Vector2(-e.y,e.x)).normalize(),this.orcaLines_.push(h));else if(0<=k&&1>k&&p<=l)h.point=new RVO.Vector2(0,0),h.direction=c.unitDir_.moinsSelf(),this.orcaLines_.push(h);else{if(0>k&&p<=l){if(!c.isConvex_)continue;
f=c;p=Math.sqrt(m-l);k=(new RVO.Vector2(g.x*p-g.y*this.radius_,g.x*this.radius_+g.y*p)).div_k(m);e=(new RVO.Vector2(g.x*p+g.y*this.radius_,-g.x*this.radius_+g.y*p)).div_k(m)}else if(1<k&&p<=l){if(!f.isConvex_)continue;c=f;g=Math.sqrt(n-l);k=(new RVO.Vector2(e.x*g-e.y*this.radius_,e.x*this.radius_+e.y*g)).div_k(n);e=(new RVO.Vector2(e.x*g+e.y*this.radius_,-e.x*this.radius_+e.y*g)).div_k(n)}else c.isConvex_?(p=Math.sqrt(m-l),k=(new RVO.Vector2(g.x*p-g.y*this.radius_,g.x*this.radius_+g.y*p)).div_k(m)):
k=c.unitDir_.moinsSelf(),f.isConvex_?(g=Math.sqrt(n-l),e=(new RVO.Vector2(e.x*g+e.y*this.radius_,-e.x*this.radius_+e.y*g)).div_k(n)):e=c.unitDir_;m=c.prevObstacle_;n=g=!1;c.isConvex_&&0<=RVO.Det(k,m.unitDir_.moinsSelf())&&(k=m.unitDir_.moinsSelf(),g=!0);f.isConvex_&&0>=RVO.Det(e,f.unitDir_)&&(e=f.unitDir_,n=!0);var m=c.point_.moins(this.position_).mul_k(a),l=f.point_.moins(this.position_).mul_k(a),r=l.moins(m),q=c==f?0.5:this.velocity_.moins(m).mul(r)/r.absSq(),s=this.velocity_.moins(m).mul(k),p=
this.velocity_.moins(l).mul(e);0>q&&0>s||c==f&&0>s&&0>p?(c=this.velocity_.moins(m).normalize(),h.direction=new RVO.Vector2(c.y,-c.x),h.point=m.plus(c.mul_k(this.radius_*a)),this.orcaLines_.push(h)):1<q&&0>p?(c=this.velocity_.moins(l).normalize(),h.direction=new RVO.Vector2(c.y,-c.x),h.point=l.plus(c.mul_k(this.radius_*a)),this.orcaLines_.push(h)):(f=0>q||1<q||c==f?Number.POSITIVE_INFINITY:this.velocity_.moins(m.plus(r.mul_k(q))).absSq(),s=0>s?Number.POSITIVE_INFINITY:this.velocity_.moins(m.plus(k.mul_k(s))).absSq(),
p=0>p?Number.POSITIVE_INFINITY:this.velocity_.moins(l.plus(e.mul_k(p))).absSq(),f<=s&&f<=p?(h.direction=c.unitDir_.moinsSelf(),h.point=m.plus((new RVO.Vector2(-h.direction.y,h.direction.x)).mul_k(this.radius_+a)),this.orcaLines_.push(h)):s<=p?g||(h.direction=k,h.point=m.plus((new RVO.Vector2(-h.direction.y,h.direction.x)).mul_k(this.radius_+a)),this.orcaLines_.push(h)):n||(h.direction=e.moinsSelf(),h.point=l.plus((new RVO.Vector2(-h.direction.y,h.direction.x)).mul_k(this.radius_+a)),this.orcaLines_.push(h)))}}}a=
this.orcaLines_.length;1===this.id_&&(this.parent.performance.orcaLines=a);d=1/this.timeHorizon_;for(b=this.agentNeighbors_.length;b--;)h=this.agentNeighbors_[b].Value,k=h.position_.moins(this.position_),c=this.velocity_.moins(h.velocity_),e=k.absSq(),f=this.radius_+h.radius_,n=RVO.Sqr(f),h=new RVO.Line,g=new RVO.Vector2(0,0),e>n?(g=c.moins(k.mul_k(d)),m=g.absSq(),l=g.mul(k),0>l&&RVO.Sqr(l)>n*m?(k=Math.sqrt(m),c=g.div_k(k),h.direction=new RVO.Vector2(c.y,-c.x),g=c.mul_k(f*d-k)):(n=Math.sqrt(e-n),
0<RVO.Det(k,g)?h.direction=(new RVO.Vector2(k.x*n-k.y*f,k.x*f+k.y*n)).div_k(e):h.direction=(new RVO.Vector2(k.x*n+k.y*f,-k.x*f+k.y*n)).div_k(e).moinsSelf(),f=c.mul(h.direction),g=h.direction.mul_k(f).moins(c))):(e=1/this.parent.timeStep_,g=c.moins(k.mul_k(e)),k=g.abs(),c=g.div_k(k),h.direction=new RVO.Vector2(c.y,-c.x),g=c.mul_k(f*e-k)),h.point=g.mul_k(0.5).plus(this.velocity_),this.orcaLines_.push(h);b=this.linearProgram2(this.orcaLines_,this.maxSpeed_,this.prefVelocity_,!1,this.newVelocity_);b<
this.orcaLines_.length&&this.linearProgram3(this.orcaLines_,a,b,this.maxSpeed_,this.newVelocity_)},insertAgentNeighbor:function(a,b){if(this!==a){var d=this.position_.moins(a.position_).absSq();if(d<this.RangeSq){this.agentNeighbors_.length<this.maxNeighbors_&&this.agentNeighbors_.push(new RVO.KeyValuePair(d,a));for(var c=this.agentNeighbors_.length-1;0!==c&&d<this.agentNeighbors_[c-1].Key;)this.agentNeighbors_[c]=this.agentNeighbors_[c-1],--c;this.agentNeighbors_[c]=new RVO.KeyValuePair(d,a);this.agentNeighbors_.length===
this.maxNeighbors_&&(this.RangeSq=this.agentNeighbors_[this.agentNeighbors_.length-1].Key)}}},update:function(){this.velocity_=this.newVelocity_;var a=this.position_;this.position_=this.position_.plus(this.velocity_.mul_k(this.parent.timeStep_));var b=a.x-this.position_.x,a=a.y-this.position_.y;0.2>Math.abs(b)&&0.2>Math.abs(a)?this.orientation_=Math.atan2(this.position_.x-this.prefVelocity_.x,this.position_.y-this.prefVelocity_.y):this.orientation_=Math.atan2(b,a)},insertObstacleNeighbor:function(a,
b){var d=RVO.DistSqPointLineSegment(a.point_,a.nextObstacle_.point_,this.position_);if(d<b){this.obstacleNeighbors_.push(new RVO.KeyValuePair(d,a));for(var c=this.obstacleNeighbors_.length-1;0!=c&&d<this.obstacleNeighbors_[c-1].Key;)this.obstacleNeighbors_[c]=this.obstacleNeighbors_[c-1],--c;this.obstacleNeighbors_[c]=new RVO.KeyValuePair(d,a)}},linearProgram1:function(a,b,d,c,f,g){g=a[b].point.mul(a[b].direction);d=RVO.Sqr(g)+RVO.Sqr(d)-a[b].point.absSq();if(0>d)return!1;var e=Math.sqrt(d);d=-g-
e;g=-g+e;var h=b,e=a[b].point;for(b=a[b].direction;h--;){var k=RVO.Det(b,a[h].direction),n=RVO.Det(a[h].direction,e.moins(a[h].point));if(Math.abs(k)<=RVO.EPSILON){if(0>n)return!1}else if(n/=k,0<=k?g=Math.min(g,n):d=Math.max(d,n),d>g)return!1}f?0<c.mul(b)?this.newVelocity_=e.plus(b.mul_k(g)):this.newVelocity_=e.plus(b.mul_k(d)):(a=b.mul(c.moins(e)),this.newVelocity_=a<d?e.plus(b.mul_k(d)):a>g?e.plus(b.mul_k(g)):e.plus(b.mul_k(a)));return!0},linearProgram2:function(a,b,d,c,f){c?this.newVelocity_=d.mul_k(b):
d.absSq()>RVO.Sqr(b)?this.newVelocity_=d.normalize().mul_k(b):this.newVelocity_=d;f=0;for(var g=a.length;f<g;++f)if(0<RVO.Det(a[f].direction,a[f].point.moins(this.newVelocity_))){var e=this.newVelocity_;if(!this.linearProgram1(a,f,b,d,c,this.newVelocity_))return this.newVelocity_=e,f}return a.length},linearProgram3:function(a,b,d,c,f){for(var g=0,e,h,k=d,n=a.length;k<n;++k)if(d=a[k].direction,f=a[k].point,RVO.Det(d,f.moins(this.velocity_))>g){g=[];for(e=0;e<b;++e)g.push(a[e]);for(var m=b;m<k;++m){var l=
new RVO.Line;e=a[m].direction;h=a[m].point;var p=RVO.Det(d,e);if(Math.abs(p)<=RVO.EPSILON)if(0<d.mul(e))continue;else l.point=f.plus(h).mul_k(0.5);else h=RVO.Det(e,f.moins(h))/p,h=d.mul_k(h),l.point=f.plus(h);l.direction=e.moins(d).normalize();g.push(l)}e=this.newVelocity_;this.linearProgram2(g,c,new RVO.Vector2(-d.y,d.x),!0,this.newVelocity_)<g.length&&(this.newVelocity_=e);g=RVO.Det(d,f.moins(this.newVelocity_))}}};RVO.Performance=function(){this.orcaLines=this.updateAgent=this.KdTree=this.fps=this.fpsint=this.time_prev=0};RVO.AgentTreeNode=function(){};RVO.Dijkstra=function(){};
RVO.Dijkstra.prototype={constructor:RVO.Dijkstra,buildRoadmap:function(a,b){for(var d=0;d<b.length;++d){for(var c=0;c<b.length;++c)a.queryVisibility(b[d].position,b[c].position,a.getAgentRadius(0))&&b[d].neighbors.push(c);for(c=0;4>c;++c)b[d].distToGoal[c]=Number.POSITIVE_INFINITY}for(d=0;4>d;++d){var f=new RVO.Multimap,g=new RVO.Multimap;b[d].distToGoal[d]=0;for(g[d]=f.keyValue.push(new RVO.KeyValuePair(0,d));0!=f.keyValue.length;){var e=f.keyValue[0].Value;f.keyValue.shift();g[e]=f.keyValue[f.keyValue.length-
1];for(c=0;c<b[e].neighbors.length;++c){var h=b[e].neighbors[c],k=Math.abs(b[h].position.moins(b[e].position));b[h].distToGoal[d]>b[e].distToGoal[d]+k&&(b[h].distToGoal[d]=b[e].distToGoal[d]+k,g[h]==f.keyValue[f.keyValue.length-1]?g[h]=f.keyValue.push(new RVO.KeyValuePair(b[h].distToGoal[d],h)):f.keyValue.push(new RVO.KeyValuePair(b[h].distToGoal[d],h)))}}}}};RVO.FloatPair=function(a,b){this._a=a;this._b=b};RVO.FloatPair.inf=function(a,b){return a._a<b._a||!(b._a<a._a)&&a._b<b._b};RVO.FloatPair.inf_equal=function(a,b){return a._a==b._a&&a._b==b._b||a<b};RVO.FloatPair.sup=function(a,b){return!RVO.FloatPair.inf_equal(a,b)};RVO.FloatPair.sup_equal=function(a,b){return!RVO.FloatPair.inf};RVO.KdTree=function(){this.parent=null;this.agents_=[];this.agentTree_=[]};
RVO.KdTree.prototype={constructor:RVO.KdTree,buildAgentTree:function(){for(var a=this.parent.agents_.length,b;a--;)this.agents_[a]=this.parent.agents_[a],b=2*a,this.agentTree_[b]=new RVO.AgentTreeNode,this.agentTree_[b+1]=new RVO.AgentTreeNode;0!==this.agents_.length&&this.buildAgentTreeRecursive(0,this.agents_.length,0)},buildAgentTreeRecursive:function(a,b,d){var c=this.agentTree_[d];c.begin=a;c.end=b;c.minX=c.maxX=this.agents_[a].position_.x;c.minY=c.maxY=this.agents_[a].position_.y;for(var f,
g=a+1;g<b;++g)f=this.agents_[g].position_,c.maxX=Math.max(c.maxX,f.x),c.minX=Math.min(c.minX,f.x),c.maxY=Math.max(c.maxY,f.y),c.minY=Math.min(c.minY,f.y);if(b-a>RVO.MAX_LEAF_SIZE){for(var g=(f=c.maxX-c.minX>c.maxY-c.minY)?0.5*(c.maxX+c.minX):0.5*(c.maxY+c.minY),e=a,h=b;e<h;){for(;e<h&&(f?this.agents_[e].position_.x:this.agents_[e].position_.y)<g;)++e;for(;h>e&&(f?this.agents_[h-1].position_.x:this.agents_[h-1].position_.y)>=g;)--h;if(e<h){var k=this.agents_[e];this.agents_[e]=this.agents_[h-1];this.agents_[h-
1]=k;++e;--h}}e==a&&++e;c.left=d+1;c.right=d+2*(e-a);this.buildAgentTreeRecursive(a,e,c.left);this.buildAgentTreeRecursive(e,b,c.right)}},computeAgentNeighbors:function(a,b){this.queryAgentTreeRecursive(a,b,0)},queryAgentTreeRecursive:function(a,b,d){d=this.agentTree_[d];var c,f,g,e;if(d.end-d.begin<=RVO.MAX_LEAF_SIZE)for(c=d.begin;c<d.end;++c)a.insertAgentNeighbor(this.agents_[c],b);else e=a.position_,f=[],f.length=4,c=this.agentTree_[d.left],f[0]=RVO.Sqr(Math.max(0,c.minX-e.x)),f[1]=RVO.Sqr(Math.max(0,
e.x-c.maxX)),f[2]=RVO.Sqr(Math.max(0,c.minY-e.y)),f[3]=RVO.Sqr(Math.max(0,e.y-c.maxY)),c=[],c.length=4,g=this.agentTree_[d.right],c[0]=RVO.Sqr(Math.max(0,g.minX-e.x)),c[1]=RVO.Sqr(Math.max(0,e.x-g.maxX)),c[2]=RVO.Sqr(Math.max(0,g.minY-e.y)),c[3]=RVO.Sqr(Math.max(0,e.y-g.maxY)),f=f[0]+f[1]+f[2]+f[3],c=c[0]+c[1]+c[2]+c[3],f<c?f<b&&(this.queryAgentTreeRecursive(a,b,d.left),c<b&&this.queryAgentTreeRecursive(a,b,d.right)):c<b&&(this.queryAgentTreeRecursive(a,b,d.right),f<b&&this.queryAgentTreeRecursive(a,
b,d.left))},buildObstacleTree:function(){this.obstacleTree_=new RVO.ObstacleTreeNode;for(var a=[],b=0;b<this.parent.obstacles_.length;++b)a[b]=this.parent.obstacles_[b];this.obstacleTree_=this.buildObstacleTreeRecursive(a)},buildObstacleTreeRecursive:function(a){if(0==a.length)return null;for(var b=new RVO.ObstacleTreeNode,d=0,c=a.length,f=a.length,g=0;g<a.length;++g){for(var e=0,h=0,k=a[g],n=k.nextObstacle_,m=0;m<a.length;++m)if(g!=m){var l=a[m],p=l.nextObstacle_,r=RVO.LeftOf(k.point_,n.point_,l.point_),
q=RVO.LeftOf(k.point_,n.point_,p.point_);r>=-RVO.EPSILON&&q>=-RVO.EPSILON?++e:(r<=RVO.EPSILON&&q<=RVO.EPSILON||++e,++h);l=new RVO.FloatPair(Math.max(e,h),Math.min(e,h));p=new RVO.FloatPair(Math.max(c,f),Math.min(c,f));if(RVO.FloatPair.sup_equal(l,p))break}l=new RVO.FloatPair(Math.max(e,h),Math.min(e,h));p=new RVO.FloatPair(Math.max(c,f),Math.min(c,f));RVO.FloatPair.inf(l,p)&&(c=e,f=h,d=g)}e=[];for(g=0;g<c;++g)e[g]=null;c=[];for(g=0;g<f;++g)c[g]=null;h=f=0;g=d;k=a[g];n=k.nextObstacle_;for(m=0;m<a.length;++m)g!=
m&&(l=a[m],p=l.nextObstacle_,r=RVO.LeftOf(k.point_,n.point_,l.point_),q=RVO.LeftOf(k.point_,n.point_,p.point_),r>=-RVO.EPSILON&&q>=-RVO.EPSILON?e[f++]=a[m]:r<=RVO.EPSILON&&q<=RVO.EPSILON?c[h++]=a[m]:(q=n.point_.moins(k.point_),d=RVO.Det(q,l.point_.moins(k.point_)),q=RVO.Det(q,l.point_.moins(p.point_)),d/=q,d=p.point_.moins(l.point_).mul_k(d),d=l.point_.plus(d),q=new RVO.Obstacle,q.point_=d,q.prevObstacle_=l,q.nextObstacle_=p,q.isConvex_=!0,q.unitDir_=l.unitDir_,q.id_=this.parent.obstacles_.length,
this.parent.obstacles_.push(q),l.nextObstacle_=q,p.prevObstacle_=q,0<r?(e[f++]=l,c[h++]=q):(c[h++]=l,e[f++]=q)));b.obstacle=k;b.left=this.buildObstacleTreeRecursive(e);b.right=this.buildObstacleTreeRecursive(c);return b},computeObstacleNeighbors:function(a,b){this.queryObstacleTreeRecursive(a,b,this.obstacleTree_)},queryObstacleTreeRecursive:function(a,b,d){if(null!=d){var c=d.obstacle,f=c.nextObstacle_,g=RVO.LeftOf(c.point_,f.point_,a.position_);this.queryObstacleTreeRecursive(a,b,0<=g?d.left:d.right);
RVO.Sqr(g)/f.point_.moins(c.point_).absSq()<b&&(0>g&&a.insertObstacleNeighbor(d.obstacle,b),this.queryObstacleTreeRecursive(a,b,0<=g?d.right:d.left))}},queryVisibility:function(a,b,d){return this.queryVisibilityRecursive(a,b,d,this.obstacleTree_)},queryVisibilityRecursive:function(a,b,d,c){if(null==c)return!0;var f=c.obstacle,g=f.nextObstacle_,e=RVO.LeftOf(f.point_,g.point_,a),h=RVO.LeftOf(f.point_,g.point_,b),k=1/g.point_.moins(f.point_).absSq();if(0<=e&&0<=h)return this.queryVisibilityRecursive(a,
b,d,c.left)&&(RVO.Sqr(e)*k>=RVO.Sqr(d)&&RVO.Sqr(h)*k>=RVO.Sqr(d)||this.queryVisibilityRecursive(a,b,d,c.right));if(0>=e&&0>=h)return this.queryVisibilityRecursive(a,b,d,c.right)&&(RVO.Sqr(e)*k>=RVO.Sqr(d)&&RVO.Sqr(h)*k>=RVO.Sqr(d)||this.queryVisibilityRecursive(a,b,d,c.left));if(0<=e&&0>=h)return this.queryVisibilityRecursive(a,b,d,c.left)&&this.queryVisibilityRecursive(a,b,d,c.right);f=RVO.LeftOf(a,b,f.point_);g=RVO.LeftOf(a,b,g.point_);e=1/b.moins(a).absSq();return 0<=f*g&&RVO.Sqr(f)*e>RVO.Sqr(d)&&
RVO.Sqr(g)*e>RVO.Sqr(d)&&this.queryVisibilityRecursive(a,b,d,c.left)&&this.queryVisibilityRecursive(a,b,d,c.right)}};RVO.KeyValuePair=function(a,b){this.Key=a;this.Value=b};RVO.Multimap=function(){this.keyValue=[]};RVO.Obstacle=function(){};RVO.ObstacleTreeNode=function(){};RVO.RoadmapVertex=function(){};RVO.Det=function(a,b){return a.x*b.y-a.y*b.x};RVO.DistSqPointLineSegment=function(a,b,d){var c=d.moins(a).mul(b.moins(a))/b.moins(a).absSq();return 0>c?d.moins(a).absSq():1<c?d.moins(b).absSq():d.moins(a.plus(b.moins(a).mul_k(c))).absSq()};RVO.LeftOf=function(a,b,d){return RVO.Det(a.moins(d),b.moins(a))};RVO.Line=function(){};RVO.Sqr=function(a){return a*a};RVO.Vector2=function(a,b){this.x=a||0;this.y=b||0};
RVO.Vector2.prototype={constructor:RVO.Vector2,moins:function(a){return new RVO.Vector2(this.x-a.x,this.y-a.y)},moinsSelf:function(){return new RVO.Vector2(-this.x,-this.y)},plus:function(a){return new RVO.Vector2(this.x+a.x,this.y+a.y)},mul:function(a){return this.x*a.x+this.y*a.y},absSq:function(a){return this.x*this.x+this.y*this.y},abs:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},mul_k:function(a){return new RVO.Vector2(this.x*a,this.y*a)},div_k:function(a){a=1/a;return new RVO.Vector2(this.x*
a,this.y*a)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},divideScalar:function(a){0!==a?(a=1/a,this.x*=a,this.y*=a):this.y=this.x=0;return this},normalize:function(){return this.divideScalar(this.length())},clone:function(){return new RVO.Vector2(this.x,this.y)}};
